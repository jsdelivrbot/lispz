<panel>
  <!-- <panel [context=default|primary|success|info|warning|danger]
              [heading=heading-text] [footer=footer-text]
              [menu=menu-id] height=[nn%,nn]>
       panel-body-content-html
       </panel>
    -->
  <div class="panel { context }" name=outer>
    <div class=panel-heading if={ opts.heading } name=heading
         ><bars-menu align=right name={ opts.menu } owner={ opts.owner }/>
         <h3 class=panel-title>{ opts.heading }</h3></div>
    <div class="panel-body" name=body><yield/></div>
    <div class=panel-footer if={ opts.footer } name=footer
         >{ opts.footer }</div>
  </div>

  <style>
    panel .panel {
      position: relative;
    }
    panel .panel-title {
      cursor: default;
    }
    panel .panel-body {
      position: absolute;
      top: 40px;
      bottom: 2px;
      left: 0;
      right: 2px;
    }
  </style>

  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (tag.on "mount" (=> (using [dom]
      (tag.update! {context: (+ "panel-" (or opts.context "default"))})
      (cond opts.height (do
        (var px opts.height)
        (cond (is "%" (opts.height.slice -1))
          (var px (/ (* window.innerHeight (opts.height.slice 0 -1)) 100))
        )
        (dom.style! tag.outer.style.height (+ px "px"))
      ))
    )))
  </script>
</panel>

<modal>
  <!--  <modal name=n [title=heading-text] [buttons=a,*b]>
          modal-body-content-html
        </modal>
  -->
  <div class="modal fade" role="dialog" aria-labelledby={ opts.name }>
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header" if={ opts.title }>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id={ opts.name }>{ opts.title }</h4>
        </div>
        <div class="modal-body"><yield/></div>
        <div class="modal-footer">
          <button each={ buttons } class="btn btn-{ type }" name={ name }>
            { title }
          </button>
        </div>
      </div>
    </div>
  </div>
  <style>
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (cond opts.buttons (do
      (tag.update! {buttons: [[]]})
      ((opts.buttons.split ",").forEach (lambda [title]
        (var primary (is "*" (first title))  type "default")
        (cond primary (do (var type "primary") (title.shift)))
        (var name title)
        (tag.buttons.push { title type name })
      ))
    ))
  </script>
</modal>

<bars-menu>
  <div name=dropdown class="dropdown { right: opts.align === 'right' }">
    <a style="text-decoration: none" data-toggle="dropdown" name=bars
    class="glyphicon glyphicon-menu-hamburger dropdown-toggle" aria-hidden="true"
    ></a>
    <ul class="dropdown-menu { dropdown-menu-right: opts.align === 'right' }">
      <li each={ items } class={ dropdown-header: header && title,
          divider: divider, disabled: disabled }><a onclick={ goto } href="#">
          <span class="pointer right float-right" if={ children }></span>
          { title }&nbsp;&nbsp;&nbsp;
      </a></li>
    </ul>
  </div>
  <style>
    bars-menu > div.right { float: right }
    bars-menu span.caret { margin-left: -11px }
    bars-menu a.dropdown-toggle { cursor: pointer }
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (tag.on "mount" (=> (using [message riot]
      (message.listen opts.name (lambda [items]
        (riot.update! tag {items root: (or items [[]])})
      ))
      (($ tag.dropdown).on "show.bs.dropdown" (=>
        (message.send (+ opts.name "-open"))
        (riot.update! tag {items: root})
      ))
      (tag.update! {goto: (lambda [ev]
        (cond ev.item.topic (message.send
          (+ opts.owner "-" ev.item.topic)
          {item: ev.item owner: opts.owner action: "select"}))
        (cond ev.item.children (do
          (tag.update! items ev.item.children)
          (ev.currentTarget.blur)
          (ev.stopPropagation)
        ))
      )})
    )))
  </script>
</bars-menu>

<tree>
  <tree-component name=base/>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (using [message riot]
      (message.listen opts.name (lambda [items]
        (riot.update! tag {children: {base: {children: items}}})
        (tag.update) ## once more for luck
      ))
    )
  </script>
</tree>

<tree-component>
  <ul class="dropdown-menu">
    <li each={ item, i in items }
        class={ dropdown-header: item.header && item.title,
        divider: item.divider, disabled: item.disabled }
        ><a onclick={ parent.goto } href="#">
        <span if={ item.children }
              class="glyphicon glyphicon-triangle-right"
              aria-hidden="true"></span>{ item.title }</a>
        <tree-component if={ item.children } name={ item.title }>
    </li>
  </ul>
  <style>
    tree-component ul {
      display: inherit !important;
      position: inherit !important;
    }
    tree-component:not([name=base]) > ul {
      display: none !important;
    }
    tree-component:not([name=base]).open > ul {
      margin-left:  9px;
      margin-right: 9px;
      display: inherit !important;
    }
    tree-component span.glyphicon {
      margin-left: -18px;
    }
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (using [message dict]
      (tag.on "update" (lambda [data]
        (cond (and opts.name tag.parent.children) (do
          (tag.update! {items: (get tag.parent.children opts.name "children")})
          (cond (and tag.items tag.items.length)
                (tag.update! {children: (dict.from-list tag.items "title")})
          )
        ))
      ))

      (tag.update! {goto: (lambda [ev]
        (var item ev.item.item)
        (var topic (or item.topic item.title ))
        (cond topic (message.send topic
          {item action: "select"}))
        (cond item.children (do
          (var tree ev.currentTarget.nextElementSibling)
          (tree.classList.toggle "open")
          (tree.parentElement.classList.toggle "bg-info")
        ))
        (ev.stopPropagation)
      )})
    )
  </script>
</tree-component>

<sidebar>
  <a aria-hidden="true" name=hamburger
    class="glyphicon glyphicon-menu-hamburger"></a>
  <div id=sidebar class="container bg-primary"><yield/></div>
  <style>
    sidebar > a {
      text-decoration: none !important;
      position: absolute !important;
      z-index: 2000;
    }
    #sidebar {
      z-index: 1000;
      position: fixed;
      width: 0;
      height: 100%;
      overflow-y: auto;
      -webkit-transition: all 0.5s ease;
      -moz-transition: all 0.5s ease;
      -o-transition: all 0.5s ease;
      transition: all 0.5s ease;
      padding-right: 0;
      overflow: hidden;
    }
    #sidebar.toggled { width: auto; padding-right: 15px; }
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this)  hamburger (stateful.morph! tag.hamburger))
    (using [message dom]
      (hamburger.update: {onclick: (=>
        (tag.sidebar.classList.toggle "toggled")
        (delay 300 ## must be after slide action
          (message.send "page-content-wrapper-padding" tag.sidebar.offsetWidth)
        )
      )})
      (tag.on "mount" (delay 300
        (message.send "page-content-wrapper-padding" tag.sidebar.offsetWidth)
      ))
    )
  </script>
</sidebar>

<page-content>
  <div id=page_content_wrapper>
    <div class={ container-fluid: opts.fluid, container: !opts.fluid }>
      <yield/>
    </div>
  </div>
  <style>
    #page_content_wrapper {
      width: 100%;
      position: absolute;
    }
  </style>
  <script type=text/lispz>
    (var tag this)
    (using [message dom]
      (message.listen "page-content-wrapper-padding" (lambda [px]
        (dom.style! tag.page-content-wrapper.style.paddingLeft (+ px "px"))
      ))
    )
  </script>
</page-content>

<bootstrap>
  <div id=page-wrapper><yield/></div>
  <style>
    .pointer {
      border: 5px solid transparent;
      display: inline-block;
      width: 0;
      height: 0;
      vertical-align: middle;
    }
    .pointer.float-right {
      float: right;
      margin-top: 5px;
    }
    .pointer.up {
        border-bottom: 5px solid;
    }
    .pointer.right {
        border-left: 5px solid;
    }
    .pointer.down {
        border-top: 5px solid;
    }
    .pointer.left {
        border-right: 5px solid;
    }
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (using  [dom net jquery riot message bootstrap]
      (var bootswatch-themes [[ "cerulean" "cosmo" "cyborg" "darkly" "flatly"
        "journal" "lumen" "paper" "readable" "sandstone" "simplex" "slate"
        "spacelab" "superhero" "united" "yeti" ]])
      ###
      # https://bootswatch.com
      # Loads a bootswatch theme to make the page look different.
      # If no theme is provided, a random one is selected.
      ###
      (message.listen "change-bootstrap-theme" (lambda [theme]
        (cond (not (defined? theme))
          (var theme (get bootswatch-themes (random bootswatch-themes.length)))
        )
        (net.css (+ "https://bootswatch.com/" theme "/bootstrap.css"))
      ))
      (dom.append! "head" (dom.element "meta"
        {name: "viewport" content: "width=device-width, initial-scale=1"}
      ))
    )
  </script>
</bootstrap>
