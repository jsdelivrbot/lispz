<!-- ### spec: components >> Code Editor
  This is a web component with a header, footer, menu and code editor.
  At the moment it wraps CodeMirror, but it could just as easily
  support Ace or FirePad.
  ### -->
<code-editor>
  <panel height={ opts.height } heading={ heading }
      menu={ menu } owner={ _id }>
    <div name=wrapper class=wrapper></div>
  </panel>
  <style>
    code-editor .wrapper {
      position: absolute;
      top: 0; bottom: 0;
      left: 0; right: 0;
      height: initial;
    }
    code-editor .CodeMirror {
      position: absolute;
      top: 0; bottom: 0;
      left: 5px; right: 0;
      height: initial;
    }
  </style>
  <script type=text/lispz>
    (var tag (stateful.morph! this))
    (tag.update! {menu: "CodeMirror-menu" heading: "Edit"})
    (tag.on "mount" (=> (using  [codemirror message dict]
      (var filename-key (+ "code-editor/" opts.name "/filename"))
      (var cm (codemirror.open tag._id tag.tags.panel.wrapper))

      (var open (lambda [packet]
        (codemirror.set-mode cm packet.key)
        (tag.update! {heading: (last (packet.key.split "/"))})
        (localStorage.setItem filename-key packet.key)
        (cond packet.contents (cm.setValue packet.contents))
        (tag.update)
      ))

      (var contents-key (+ "code-editor/" opts.name "/contents"))
      (var filename (localStorage.getItem filename-key))
      (cond filename (delay 100
        (open {key: filename contents: (localStorage.getItem contents-key)})
      ))
      (cm.on "change" (=>
        (localStorage.setItem contents-key (cm.getValue))
      ))

      (message.dispatch (+ "code-editor/" opts.name) { open })
    )))
  </script>
</code-editor>
