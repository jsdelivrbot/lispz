<firepad>
  <!-- <firepad name=pad-name [db=default]> -->
  <panel height={ opts.height } heading={ heading }
      menu={ menu } owner={ _id }>
    <div name=wrapper class=wrapper></div>
  </panel>
  <style>
    firepad .wrapper {
      position: absolute;
      top: 0; bottom: 0;
      left: 0; right: 0;
      height: initial;
    }
    firepad .CodeMirror {
      position: absolute;
      top: 0; bottom: 0;
      left: 5px; right: 0;
      height: initial;
    }
    a.powered-by-firepad { display: none; }
    div.firepad-toolbar { margin-top: -25px; }
  </style>
  <script type=text/lispz>
    (var tag this)
    (set! tag.menu "CodeMirror-menu")
    (set! tag.heading "Edit")
    (using  "firebase codemirror firepad message"
      (var cm (codemirror.open tag._id tag.tags.panel.wrapper) pad null)
      (var db (firebase.attach (+ "firepads/" opts.name) opts.db))
      (set! pad (Firepad.fromCodeMirror db cm
        {richTextShortcuts: false richTextToolbar: false}
      ))

      (var open (lambda [packet]
        (codemirror.set-mode cm packet.key)
        (set! tag.heading (last (packet.key.split "/")))
        (cond packet.contents (pad.setText packet.contents))
        (tag.update)
      ))

      (pad.on "ready" (=>
        (message.dispatch (+ "firepad/" opts.name) { open })
      ))
    )
  </script>
</firepad>
