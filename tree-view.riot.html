<tree-view>
  <ul name=tree>
    <li class=branch branch={ tree_root.style.branch }
    path={ "/"+tree_root.title } >
      <tree-item if={ tree_root }
      branch={ tree_root } base="" />
    </li>
  </ul>
  <style>
    tree-view {
      color: black;
      margin-top: 10px;
    }
    tree-view > ul {
      padding: 3px 0 0 0 !important;
    }

    tree-view li {
        list-style-type:none;
        margin:0;
        padding:5px 5px 0 5px;
        position:relative;
        cursor:pointer;
    }

    tree-view hidden { display: none }
  </style>

  <script type="text/lispz">
    (riot-tag (mount-tag-using [message dom riot]
      (ref address (+ "tree-view/" opts.name))

      (ref get-li (=> (($ @).closest "li")))

      (ref is-branch (=> ((get-li @).hasClass "branch")))

      (ref is-leaf (=> ((get-li @).hasClass "leaf")))

      (ref toggle-open-state (=>
        (ref li (get-li @))
        (ref siblings (li.siblings ".branch"))
        (ref tree-item (li.children "tree-item"))
        (ref button (tree-item.children "button"))

        (button.toggleClass "closed")
        (ref state (cond (button.hasClass "closed") (do
          ## show everyone else on the same level
          (siblings.removeClass "hidden")
          "closed"
        ) (else) (do ## opening this branch
          ## hide everyone else on the same level
          (siblings.addClass "hidden")
          "open"
        )))
        { state name: (li.attr "branch") path: (li.attr "path") }
      ))

      (ref process-branch (lambda [event context]
        (ref packet (toggle-open-state event.srcElement))
        (ref address (+ context.address "/" packet.state "/" packet.name))
        (message.send address packet)
      ))

      (ref process-leaf (lambda [event context]
        (ref li (get-li event.srcElement))
        (ref address (+ context.address "/" (li.attr "leaf")))
        (message.send address { path: (li.attr "path") } )
      ))

      (cascade
        (=> (dom.click tag.tree address))
        ### ref:    tree-view/{{name}}/dom/click  {{MouseEvent}}
            when any item in the tree is clicked
        ###
        (=> (tee @
          (=> (message.filter @ "branch" (=> (is-branch @.srcElement))))
          ### ref:    tree-view/{{name}}/dom/click/branch  (MouseEvent)
              when a branch is clicked
          ###
          (=> (message.listen  @ process-branch))
          ### ref: branches can be processed with different actors
              tree-view/{{name}}/dom/click/branch/{{open|closed}}/{{actor}}
              packet: { path: "a/path" }

          ###
        ))
        (=> (message.filter @ "leaf"   (=> (is-leaf @.srcElement))))
        ### ref:    tree-view/{{name}}/dom/click/leaf  {{MouseEvent}}
            when a leaf node is clicked
        ###
        (=> (message.map    @ "" (=> (process-leaf  @.srcElement))))
        ### ref:    tree-view/{{name}}/dom/click/leaf/{{actor}}
            packet: { path: "a/path" } }
            leaves can be set with different actors
        ###
      )
      ### ref: tree-view/{{name}}/add-branch
          packet:   { base: path, branch: dict }
          response: Promise { dom-li of branch }
      ###
      (message.listen (+ address "/add-branch") (lambda [packet]
        (riot.update! tag { tree-root: packet.branch })
      ))
    ))
  </script>
</tree-view>

<tree-item>
  <button if={ children } class="closed btn btn-{ color }">
    <span class="open glyphicon glyphicon-{ open }"></span>
    <span class="closed glyphicon glyphicon-{ closed }"></span>
    <div>{ title }</div>
  </button>
  <ul if={children}>
    <li each={ key, child in children } name={ key }
    path={ base+"/"+child.title }
    branch={ child.style.branch } leaf={ child.style.leaf }
    class={ branch: child.children, leaf: !child.children }>
      <tree-item branch={ child } base={ base }/>
    </li>
  </ul>
  <span if={ !children }>{title}</span>

  <style>
    tree-view ul {
      padding-left: 16px;
    }
    tree-view li > button.btn {
      padding: 3px 6px;
    }
    tree-view button > span.glyphicon + div {
      float: right;
      padding-left: 6px;
      position: relative;
    }
    tree-view button > span.open { display: inherit; }
    tree-view button > span.closed { display: none; }
    tree-view button.closed > span.open { display: none; }
    tree-view button.closed > span.closed { display: inherit; }

    tree-view li:hover {
      font-weight: bolder;
    }
    tree-view li.branch:hover {
      color: darkblue;
    }
    tree-view li.leaf:hover {
      font-style: italic;
      color: brown;
    }
    tree-view li.branch > span:hover {
      color: darkred;
    }
    tree-view button.closed + ul {
      display: none;
    }
  </style>

  <script type="text/lispz">
    (riot-tag (mount-tag-using [riot]
      (riot.update! tag {
        title:    opts.branch.title
        color:    (or opts.branch.style.color  "default")
        open:     (or opts.branch.style.open   "folder-open")
        closed:   (or opts.branch.style.closed "folder-close")
        branch:   (or opts.branch.style.branch "branch")
        leaf:     (or opts.branch.style.leaf   "leaf")
        base:     (+ opts.base "/" opts.branch.title)
        children: opts.branch.children
      })
    ))
  </script>
</tree-item>
