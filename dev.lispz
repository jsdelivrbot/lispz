(using [github riot list]
  (var manifest (=>
    (var text [["CACHE MANIFEST"]])
    (lispz.manifest.forEach (lambda [uri] (text.push uri)))
    (text.push "NETWORK:" "*")
    (return (text.join "\n"))
  ))
  ### Package Lispz for distribution ###
  (var package (lambda [lispz-repo]
    (var read-file (github.read.bind null lispz-repo))

    (var group (lambda [files]
      (var modules [[]] riots [[]])
      (files.forEach (lambda [entry]
        (return? (not (is "file" entry.type)))
        (var parts (entry.name.split "."))
        (cond
          (is (last parts) "lispz")                  (modules.push (first parts))
          (is ((slice parts -2).join ".") "riot.html") (riots.push (first parts))
        )
      ))
      (return (promise.resolved {modules riots}))
    ))
    (var build-modules (promise [names]
      (var load-module (lambda [name]
        (return (when (read-file (+ name ".lispz")) [text]
          (var contents (text.replace '/[\\"]/g' "\\$&"))
          (var contents (contents.replace '/\n/g' "\\n"))
          (return [["\nlispz_modules['" name "']=\"" contents "\"\n"]])
        ))
      ))
      (return (promise.all (names.map load-module)))
    ))
    (var build-riots (promise [names]
      (var source [[]])
      (var load-riot (lambda [name]
        (return (when (read-file (+ name ".riot.html") [text]
          (return [["\n\n/*" name "*/\n\nlispz.tags['" name "']=function(){"
            (riot.compile text true) "}\n"]])
        ))
      ))
      (return (promise.all (names.map load-riot)))
    ))

    (var update-mode (github.update lispz-repo))
    (var lispz-js    (when update-mode [] (return (read-file "lispz.js"))))
    (var listing     (when update-mode []  (return (github.list-dir lispz-repo ""))))
    (var groups      (when listing [files] (return (group files))))
    (var modules     (when groups [files]  (return  (build-modules files.modules))))
    (var riots       (when groups [files]  (return  (build-riots files.riots))))

    (var all-loaded  (promise.all modules lispz-js riots))

    (return (when all-loaded [sources]
      (var  code  (list.flatten [["window.lispz_modules={}\n" sources]]))
      (return (github.write lispz-repo "ext/lispz.js"
        (code.join "") "lispz release code")
      )
    ))
  ))

  ### Distribution ###
  (var distribute (lambda [target-repo]
  ))

  (export {manifest package distribute})
)
